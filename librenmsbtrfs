 Librenms est un super outil de métrologie/supervision. Hors, comme il sait gérer un nombre immense de métriques, nous pouvons nous retrouver avec une quantité gigantesque de fichiers RRD (pour ma part j'ai eu à gérer plusieurs centaines de giga de fichiers RRD..). Au delà de l'espace disque nécessaire, nous pouvons nous retrouver avec un grand nombre d'IO, ce qui oblige à utiliser des infrastructures très véloces. 

Ainsi, si vous souhaitez gérer un grand nombre d'équipements (pour mon cas plusieurs milliers), je vous propose une stratégie de stockage qui limitera les impacts de ce grand nombre de fichiers RRD (votre rrdcached ne pourra que vous en remercier).

L'idée est d'avoir un stockage à part pour vos fichiers RRD. Cela peut être une partition spécifique sur le même disque que votre installation, ou sur un autre disque (encore mieux) à part. Cette partition sera formatée avec le système de fichiers BTRFS (avec ZFS cela peut fonctionner aussi). L'intérêt de BTRFS, c'est que vous allez pouvoir utiliser deux possibilités natives :

- La déduplication des blocks.

- La compression en temps réel.

En fait, c'est assez simple. Le système de fichiers BTRFS (même avec le simple algo lzo de base) saura compresser de manière massive vos fichiers RRD. Ceci vient du fait que vos fichiers RRD sont de simples fichiers texte, donc facilement compressible. 

Le simple fait d'avoir dorénavant des fichiers compressés va faire que vous allez réduire de manière massive :

- l'impact sur l'espace disque utilisé par vos fichiers RRD.

- L'impact sur  les IO, du fait que comme les fichiers stockés sont plus petits, le nombre d'IO pour les lire sont plus faibles.

Quid de l'impact en charge CPU pour la compression. Au vu de nos CPU moderne, je dirai quasi nul. J'utilise cette technique pour superviser plus de 4000 équipements (ASR Cisco, switchs, etc.), et globalement cela a été assez impresionnant. Pour vous donnez une idée, l'un de mes espaces de stockages arrivaient à 200Go de métriques, en activant la compression et la déduplication, je suis passé à 36Go de métriques..  Le tout sans perdre une données et en ayant un impact CPU très faible et des IO énormément libérées.

Voyons maintenant l'aspect pratique. 

Pour mon cas ma partition de base BTRFS est sur /dev/vdb1. A la base il était déjà en BTRFS, donc je vous laisse le soin de consulter des tutoriaux pour installer BTRFS. Dans mon cas, la compression n'était pas activée par défaut.

Je l'ai donc activé dans /etc/fstab :

/dev/vdb1       /rrd btrfs defaults,compress=lzo  0 0

 

Vous pouvez comme option de compress, utiliser zlib, mais attendez-vous à un impact plus fort sur le CPU. A vous de juger :)

La, on peut se dire que c'est fait, comme notre beau système de fichiers va tout compresser tout seul, et que je vais voir l'espace disque utilisé fondre comme neige au soleil... ET BIEN NON !

Tout d'abord, il faut rebooter la machine pour que cela soit prit en compte. Ensuite, il faut en fait forcer le système de fichiers à compresser ce qui ne l'a pas déjà été de base. La raison en est simple, c'est que BTRFS compresse lorsque un fichier est créé et que la compression est activée. Lorsqu'il est créé et que la compression est activée, il continu à se compresser au fur et à mesure des écritures. S'il n'était pas compressé de base, il faut le forcer une première fois.

Pour cela j'ai utilisé un super outil qui se nomme : btrfs (et oui, trop facile..). Voici la ligne que j'ai utilisé pour forcer les fichiers qui étaient déjà présents à se compresser :

btrfs filesystem defragment -r -v -clzo /opt/librenms/rrd
 

Là, vous pouvez prendre un café, manger une pizza, ou bien continuer de travailler sur un autre sujet.. Car c'est lonnnnggg :



Lorsque cela sera fait, vous vous rendrez compte de la magie de la compression en temps réel :)

Une astuce consiste aussi à utiliser cette commande pour compresser soit un fichier spécifique, soit tout un répertoire pour tous les nouveaux fichiers qui arriveront :

chattr +c [lefichier|lerpertoire]

Comme je le disais, le fait de compresser sous BTRFS améliore la performance. Je vous joins ce lien qui en parle, vous verrez c'est assez probant :

https://www.phoronix.com/scan.php?page=article&item=btrfs_compress_2635&num=1

N'hésitez pas à partager vos expériences sur ce sujet et à critiquer cet article :)

 
